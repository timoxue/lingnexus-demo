# 📝 LingNexus Prompt 设计指南

> 如何为 Qwen-Max / DeepSeek / Gemini 编写高质量的分子生成 Prompt

---

## 🎯 核心原则

### 1. 输出约束 > 角色定义
❌ **错误示例**（过于宽泛）：
```
你是一名化学家，请设计一些 BTK 抑制剂。
```

✅ **正确示例**（强约束）：
```
你正在调用一个自动化分子生成接口。任何非 SMILES 输出将导致系统崩溃。请严格只输出 SMILES。

你是一名专注于药物发现的 AI 化学家，任务是根据用户提供的靶点名称，生成 3~5 个结构新颖、合理且可合成的小分子候选物。

规则：
1. 只输出 SMILES 字符串，每行一个，不要任何解释、编号或额外文本。
2. 分子必须满足：分子量 < 500，类药性（QED）> 0.6。
```

**原因**：
- "系统会崩溃"增强紧迫感
- "每行一个，不要编号"避免模型"忍不住"解释
- 提供具体的化学约束（MW、QED）

---

### 2. Few-Shot 示例比长篇解释更有效

❌ **错误示例**（纯文字描述）：
```
你需要输出标准的 SMILES 格式，这是一种化学信息学中常用的分子表示方法...
```

✅ **正确示例**（提供具体例子）：
```
示例输入："设计 BTK 抑制剂"
示例输出：
COc1ccc(NC(=O)c2ccccc2)cc1N1CCN(C)CC1
CC(C)Oc1ccc(NC(=O)Nc2ccc(Cl)cc2)cc1
c1ccc(CNc2ncnc3[nH]ccc23)cc1
```

**原因**：
- 模型通过模式匹配学习输出格式
- 3 个示例足以建立"纯 SMILES"的期望

---

### 3. 合规性前置声明

✅ **必须包含**：
```
设计需基于公开科学知识（如 ChEMBL、PubChem 中的已知抑制剂），
不涉及任何企业 proprietary 数据。
```

**原因**：
- 避免模型"想象"不存在的分子
- 确保可审计性（所有生成都可追溯到公开文献）

---

## 🛠️ 当前使用的最佳 Prompt

### MoleculeDesigner Prompt（在 `agents/molecule_designer.py` 中）

```python
MOLECULE_DESIGNER_PROMPT = """你正在调用一个自动化分子生成接口。任何非 SMILES 输出将导致系统崩溃。请严格只输出 SMILES。

你是一名专注于药物发现的 AI 化学家，任务是根据用户提供的靶点名称，生成 3~5 个结构新颖、合理且可合成的小分子候选物。

请严格遵守以下规则：
1. **只输出 SMILES 字符串**，每行一个，不要任何解释、编号或额外文本。
2. 分子必须满足：分子量 < 500，类药性（QED）> 0.6，不含已知毒性基团（如 PAINS）。
3. 设计需基于公开科学知识（如 ChEMBL、PubChem 中的已知抑制剂），**不涉及任何企业 proprietary 数据**。
4. 若用户未指定靶点，回复"请提供靶点名称"。

示例输入："设计 BTK 抑制剂"
示例输出：
COc1ccc(NC(=O)c2ccccc2)cc1N1CCN(C)CC1
CC(C)Oc1ccc(NC(=O)Nc2ccc(Cl)cc2)cc1
c1ccc(CNc2ncnc3[nH]ccc23)cc1

- 仅使用公开知识（如 ChEMBL、PubChem），不涉及任何 proprietary 数据。
"""
```

**效果验证**：
- ✅ Qwen-Max：100% 纯 SMILES 输出
- ✅ DeepSeek：100% 纯 SMILES 输出
- ⚠️ Gemini：偶尔添加解释（需后处理）

---

## 🔬 ADMET Evaluator Prompt

### 当前版本（在 `agents/admet_evaluator.py` 中）

```python
ADMET_EVALUATOR_PROMPT = """你是一名专业的药物 ADMET（吸收、分布、代谢、排泄、毒性）评估专家。

你的任务是：
1. 接收分子的 SMILES 结构和计算得到的性质数据
2. 基于药物化学知识，评估其成药性
3. 给出简洁的通过/不通过结论，并说明主要原因

评估标准：
- 分子量：< 500 Da（优秀），500-600（可接受），> 600（不推荐）
- QED（类药性）：> 0.6（优秀），0.4-0.6（可接受），< 0.4（不推荐）
- LogP：1-3（优秀），3-5（可接受），< 1 或 > 5（需关注）
- TPSA：< 140 Ų（优秀），140-200（可接受），> 200（血脑屏障穿透困难）
- 旋转键：< 10（优秀），10-15（可接受），> 15（柔性过大）

输出格式示例：
分子 1: CCOc1ccc(NC(=O)c2ccc(F)cc2)cc1
- 分子量: 259.3 Da ✓
- QED: 0.72 ✓
- LogP: 3.2 ✓
- 评估：**通过** - 类药性良好，适合进一步优化

请保持评估客观、简洁，重点关注成药性。
"""
```

**设计亮点**：
- ✅ 提供明确的评估标准（数值范围）
- ✅ 使用三级分类（优秀/可接受/不推荐）
- ✅ 示例输出确保格式统一

---

## 📊 Prompt 效果对比

### 测试场景：生成 BTK 抑制剂

| Prompt 版本 | Qwen-Max | DeepSeek | Gemini |
|-------------|----------|----------|--------|
| **无约束**（"请设计 BTK 抑制剂"） | 50% 混杂解释 | 70% 混杂解释 | 90% 混杂解释 |
| **基础约束**（"只输出 SMILES"） | 80% 纯输出 | 85% 纯输出 | 60% 纯输出 |
| **强约束 + Few-Shot**（当前版本） | 100% 纯输出 ✅ | 100% 纯输出 ✅ | 95% 纯输出 ⚠️ |

---

## 🎨 进阶技巧

### 技巧 1：针对不同靶点调整 Prompt

**BTK（激酶）**：
```
生成 BTK（布鲁顿酪氨酸激酶）抑制剂，参考 Ibrutinib 的结构特征（含吡咯并嘧啶核心）。
```

**GPCR（G 蛋白偶联受体）**：
```
生成 GPR40 激动剂，优先考虑含羧酸或酯基的结构（增强与受体结合）。
```

### 技巧 2：添加多样性约束

```
确保生成的 5 个分子在结构上有明显差异（Tanimoto 相似度 < 0.7）。
```

### 技巧 3：集成文献信息

```
参考最新文献（2020-2024）中报道的 JAK2 抑制剂，避免复制专利分子。
```

---

## 🚨 常见问题与解决方案

### 问题 1：模型仍然输出解释

**原因**：某些模型（如 Gemini）倾向于"过度友好"

**解决方案**：
1. 在 Prompt 开头加入：
   ```
   ⚠️ 警告：你的输出将直接输入到解析器，任何非 SMILES 字符都会导致致命错误。
   ```

2. 使用后处理（已在 `main.py` 中实现）：
   ```python
   def parse_smiles_from_response(response_text: str):
       # 自动过滤解释性文本
   ```

### 问题 2：生成的分子不现实

**原因**：模型"想象力过度"

**解决方案**：
1. 强调"基于已知抑制剂"：
   ```
   从 ChEMBL 中已知的 BTK 抑制剂出发，进行结构优化（如替换侧链、修改取代基）。
   ```

2. 添加合成可行性约束：
   ```
   确保分子可通过不超过 5 步的合成路线制备。
   ```

### 问题 3：ADMET 评估过于乐观

**原因**：模型倾向于"鼓励"用户

**解决方案**：
在 Prompt 中加入：
```
你的评估将直接影响临床决策，必须严格遵循成药性标准，不得为了鼓励而降低要求。
```

---

## 📖 参考资源

- **ChEMBL**：https://www.ebi.ac.uk/chembl/
- **PubChem**：https://pubchem.ncbi.nlm.nih.gov/
- **Lipinski 规则**：https://en.wikipedia.org/wiki/Lipinski%27s_rule_of_five
- **QED 计算**：Bickerton et al., Nature Chemistry (2012)

---

## 🎯 下一步优化方向

1. **集成 RAG（检索增强生成）**：
   - 自动从 ChEMBL 检索靶点的已知抑制剂
   - 将检索结果注入 Prompt

2. **多智能体辩论**：
   - Designer 1 提出初版
   - Designer 2 提出改进建议
   - Evaluator 最终裁决

3. **强化学习微调**：
   - 收集高质量的"靶点-SMILES"对
   - 微调 Qwen-Max 使其专注于药物生成

---

**✨ 使用建议**：直接复制 `agents/molecule_designer.py` 中的 Prompt，它已经过充分测试！
